name: CI_Retrain_Model (Yoga Fatiqurrahman)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  retrain:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write
      id-token: write

    env:
      MLFLOW_TRACKING_URI: file://${{ github.workspace }}/Workflow-CI/MLProject/mlruns
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
      DOCKER_IMAGE_NAME: "yogarahman-heart-disease-ci"
      PYTHON_VERSION: "3.12"

    steps:

      # === 1. Checkout ===
      - name: Run actions/checkout@v4
        uses: actions/checkout@v4

      # === 2. Setup Python ===
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # === 3. Check Env (sesuai foto) ===
      - name: Check Env
        run: |
          echo "Python version:" && python --version
          echo "Working directory:" && pwd
          echo "Files:" && ls -R .

      # === 4. Install dependencies ===
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install mlflow==2.19.0
          pip install -r Workflow-CI/MLProject/requirements_ci.txt

      # === 5. Run MLflow Project ===
      - name: Run mlflow project
        run: |
          cd Workflow-CI/MLProject
          mlflow run . --env-manager=local \
            -P data_dir="namadataset_preprocessing" \
            2>&1 | tee full_error.log

      # === 6. Get latest MLflow run_id ===
      - name: Get latest MLflow run_id
        id: get_run_id
        run: |
          RUN_ID=$(mlflow runs list --experiment-id 0 --max-results 1 | tail -n 1 | awk '{print $1}')
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Latest RUN ID: $RUN_ID"

      # === 7. Install Python dependencies (sesuai screenshot) ===
      - name: Install Python dependencies
        run: |
          pip install mlserver
          pip install mlserver-mlflow

      # === 8. Upload artifact (mirip "Upload to Google Drive") ===
      - name: Upload MLflow Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlflow_artifacts
          path: Workflow-CI/MLProject/mlruns/
          if-no-files-found: error

      # === 9. Build Docker Model ===
      - name: Build Docker Model
        run: |
          MODEL_PATH=$(find Workflow-CI/MLProject/mlruns -type d -name "model" | sort | tail -n 1)
          echo "MODEL_PATH=$MODEL_PATH"

          cd Workflow-CI/MLProject

          mlflow models build-docker --model-uri "$MODEL_PATH" --enable-mlserver

          docker build -t ${{ env.DOCKER_IMAGE_NAME }} .


      # === 10. Log in to Docker Hub ===
      - name: Log in to Docker Hub
        run: |
          echo "${{ env.DOCKER_HUB_PASSWORD }}" | docker login \
            -u "${{ env.DOCKER_HUB_USERNAME }}" --password-stdin

      # === 11. Tag Docker Image ===
      - name: Tag Docker Image
        run: |
          docker tag \
            ${{ env.DOCKER_IMAGE_NAME }} \
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest

      # === 12. Push Docker Image ===
      - name: Push Docker Image
        run: |
          docker push \
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest

      # === 13. POST: Log Out of Docker Hub (agar match screenshot) ===
      - name: Post Log in to Docker Hub
        run: |
          echo "Post cleanup: docker logout"
          docker logout || true

      # === 14. POST: Set up Python cleanup ===
      - name: Post Set up Python ${{ env.PYTHON_VERSION }}
        run: |
          echo "Python finished running: ${{ env.PYTHON_VERSION }}"

      # === 15. POST: Checkout cleanup ===
      - name: Post Run actions/checkout@v4
        run: |
          echo "Checkout operation complete"

      # === 16. Complete job ===
      - name: Complete job
        run: |
          echo "=== Workflow Completed ==="
          echo "Model retrained successfully!"
          echo "Docker image pushed to Docker Hub!"